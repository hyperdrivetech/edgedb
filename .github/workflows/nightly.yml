name: Build Test and Publish Nightly Packages

on:
  push:
    branches:
      - nightly

jobs:
#   build-linux:
#     runs-on: ubuntu-latest
#     strategy:
#       max-parallel: 4
#       matrix:
#         target: [
#           debian-stretch,
#           ubuntu-xenial,
#           centos-7,
#         ]
#         include:
#           - target: debian-stretch
#             platform: debian
#             platform_version: stretch
#           - target: ubuntu-xenial
#             platform: ubuntu
#             platform_version: xenial
#           - target: centos-7
#             platform: centos
#             platform_version: 7

#     steps:

#     - name: Build (${{ matrix.target }})
#       uses: edgedb/edgedb-pkg/integration/containers/python/debian-stretch@gha
#       if: matrix.target == 'debian-stretch'
#       env:
#         SRC_REVISION: "${{ github.sha }}"
#         PKG_REVISION: "<current-date>"
#         PKG_SUBDIST: "nightly"
#         PKG_PLATFORM: "${{ matrix.platform }}"
#         PKG_PLATFORM_VERSION: "${{ matrix.platform_version }}"

#     - name: Test (${{ matrix.target }})
#       uses: edgedb/edgedb-pkg/integration/containers/test/debian-stretch@gha
#       if: matrix.target == 'debian-stretch'
#       env:
#         PKG_SUBDIST: "nightly"
#         PKG_PLATFORM: "${{ matrix.platform }}"
#         PKG_PLATFORM_VERSION: "${{ matrix.platform_version }}"

#     - name: Build (${{ matrix.target }})
#       uses: edgedb/edgedb-pkg/integration/containers/python/ubuntu-xenial@gha
#       if: matrix.target == 'ubuntu-xenial'
#       env:
#         SRC_REVISION: "${{ github.sha }}"
#         PKG_REVISION: "<current-date>"
#         PKG_SUBDIST: "nightly"
#         PKG_PLATFORM: "${{ matrix.platform }}"
#         PKG_PLATFORM_VERSION: "${{ matrix.platform_version }}"

#     - name: Test (${{ matrix.target }})
#       uses: edgedb/edgedb-pkg/integration/containers/test/ubuntu-xenial@gha
#       if: matrix.target == 'ubuntu-xenial'
#       env:
#         PKG_SUBDIST: "nightly"
#         PKG_PLATFORM: "${{ matrix.platform }}"
#         PKG_PLATFORM_VERSION: "${{ matrix.platform_version }}"

#     - name: Build (${{ matrix.target }})
#       uses: edgedb/edgedb-pkg/integration/containers/python/centos-7@gha
#       if: matrix.target == 'centos-7'
#       env:
#         SRC_REVISION: "${{ github.sha }}"
#         PKG_REVISION: "<current-date>"
#         PKG_SUBDIST: "nightly"
#         PKG_PLATFORM: "${{ matrix.platform }}"
#         PKG_PLATFORM_VERSION: "${{ matrix.platform_version }}"

#     - name: Test (${{ matrix.target }})
#       uses: edgedb/edgedb-pkg/integration/containers/test/centos-7@gha
#       if: matrix.target == 'centos-7'
#       env:
#         PKG_SUBDIST: "nightly"
#         PKG_PLATFORM: "${{ matrix.platform }}"
#         PKG_PLATFORM_VERSION: "${{ matrix.platform_version }}"


#     - uses: actions/upload-artifact@v1
#       with:
#         name: builds-${{ matrix.target }}
#         path: artifacts/${{ matrix.target }}

  build-macos:
    runs-on: macos-10.14

    steps:
    - uses: actions/checkout@v1
      with:
        repository: edgedb/edgedb-pkg
        ref: gha
        path: edgedb/edgedb-pkg

    - name: Build (macOS)
      env:
        PKG_SUBDIST: "nightly"
        PKG_PLATFORM: "macOS"
      run: |
        edgedb-pkg/integration/macos/build.sh

    - name: Test (macOS)
      env:
        PKG_SUBDIST: "nightly"
        PKG_PLATFORM: "macOS"
      run: |
        edgedb-pkg/integration/macos/test.sh

#   publish:
#     needs: [build-linux, build-macos]
#     runs-on: ubuntu-latest
#     strategy:
#       max-parallel: 4
#       matrix:
#         target: [
#           debian-stretch,
#           ubuntu-xenial,
#           centos-7,
#         ]
#         include:
#           - target: debian-stretch
#             platform: debian
#             platform_version: stretch
#           - target: ubuntu-xenial
#             platform: ubuntu
#             platform_version: xenial
#           - target: centos-7
#             platform: centos
#             platform_version: 7

#     steps:
#     - uses: actions/download-artifact@v1
#       with:
#         name: builds-${{ matrix.target }}
#         path: artifacts/${{ matrix.target }}

#     - name: Describe
#       id: describe
#       uses: edgedb/edgedb-pkg/integration/containers/describe/debian@gha
#       env:
#         PKG_SUBDIST: "nightly"
#         PKG_PLATFORM: "${{ matrix.platform }}"
#         PKG_PLATFORM_VERSION: "${{ matrix.platform_version }}"

#     - name: Publish (${{ matrix.target }})
#       uses: edgedb/edgedb-pkg/integration/containers/upload/debian@gha
#       if: matrix.target == 'debian-stretch'
#       env:
#         PKG_SUBDIST: "nightly"
#         PKG_PLATFORM: "${{ matrix.platform }}"
#         PKG_PLATFORM_VERSION: "${{ matrix.platform_version }}"
#         PKG_VERSION_SLOT: "${{ steps.describe.outputs.edb-version-slot }}"
#         PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

#     - name: Test Published (${{ matrix.target }})
#       uses: edgedb/edgedb-pkg/integration/containers/testpublished/debian-stretch@gha
#       if: matrix.target == 'debian-stretch'
#       env:
#         PKG_SUBDIST: "nightly"
#         PKG_PLATFORM: "${{ matrix.platform }}"
#         PKG_PLATFORM_VERSION: "${{ matrix.platform_version }}"
#         PKG_VERSION_SLOT: "${{ steps.describe.outputs.edb-version-slot }}"

#     - name: Publish (${{ matrix.target }})
#       uses: edgedb/edgedb-pkg/integration/containers/upload/debian@gha
#       if: matrix.target == 'ubuntu-xenial'
#       env:
#         PKG_SUBDIST: "nightly"
#         PKG_PLATFORM: "${{ matrix.platform }}"
#         PKG_PLATFORM_VERSION: "${{ matrix.platform_version }}"
#         PKG_VERSION_SLOT: "${{ steps.describe.outputs.edb-version-slot }}"
#         PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

#     - name: Test Published (${{ matrix.target }})
#       uses: edgedb/edgedb-pkg/integration/containers/testpublished/ubuntu-xenial@gha
#       if: matrix.target == 'ubuntu-xenial'
#       env:
#         PKG_SUBDIST: "nightly"
#         PKG_PLATFORM: "${{ matrix.platform }}"
#         PKG_PLATFORM_VERSION: "${{ matrix.platform_version }}"
#         PKG_VERSION_SLOT: "${{ steps.describe.outputs.edb-version-slot }}"

#     - name: Publish (${{ matrix.target }})
#       uses: edgedb/edgedb-pkg/integration/containers/upload/redhat@gha
#       if: matrix.target == 'centos-7'
#       env:
#         PKG_SUBDIST: "nightly"
#         PKG_PLATFORM: "${{ matrix.platform }}"
#         PKG_PLATFORM_VERSION: "${{ matrix.platform_version }}"
#         PKG_VERSION_SLOT: "${{ steps.describe.outputs.edb-version-slot }}"
#         PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

#     - name: Test Published (${{ matrix.target }})
#       uses: edgedb/edgedb-pkg/integration/containers/testpublished/centos-7@gha
#       if: matrix.target == 'centos-7'
#       env:
#         PKG_SUBDIST: "nightly"
#         PKG_PLATFORM: "${{ matrix.platform }}"
#         PKG_PLATFORM_VERSION: "${{ matrix.platform_version }}"
#         PKG_VERSION_SLOT: "${{ steps.describe.outputs.edb-version-slot }}"


#     - uses: actions/checkout@v1
#       with:
#         repository: edgedb/edgedb-docker
#         ref: master
#         path: edgedb/dockerfile

#     - name: Publish Docker Image (${{ matrix.target }})
#       uses: elgohr/Publish-Docker-Github-Action@2.6
#       if: matrix.target == 'debian-stretch'
#       with:
#         name: edgedb/edgedb:nightly
#         username: ${{ secrets.DOCKER_USERNAME }}
#         password: ${{ secrets.DOCKER_PASSWORD }}
#         snapshot: true
#         workdir: dockerfile
#         buildargs: version=${{ steps.describe.outputs.edb-version-slot }},subdist=.nightly
